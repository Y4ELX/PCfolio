<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Browser</title>
    <style>
        @font-face {
            font-family: pixel;
            src: url(assets/pixel.ttf);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: pixel;
            background-color: #151924;
            color: #40FF23;
            overflow: hidden;
            height: 100vh;
        }

        .browser-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #151924;
            border: 2px solid #40FF23;
        }

        .browser-header {
            background-color: #0c0e14;
            padding: 5px;
            border-bottom: 2px solid #40FF23;
            display: flex;
            align-items: center;
        }

        .browser-title {
            color: #40FF23;
            font-size: 14px;
            margin: 0;
        }

        .tabs-container {
            background-color: #1a1f2e;
            display: flex;
            border-bottom: 2px solid #40FF23;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background-color: #151924;
            border-right: 1px solid #40FF23;
            cursor: pointer;
            color: #40FF23;
            font-size: 12px;
            white-space: nowrap;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 2px solid transparent;
        }

        .tab.active {
            background-color: #40FF23;
            color: #151924;
            border-top: 2px solid #40FF23;
        }

        .tab:hover:not(.active) {
            background-color: #1a1f2e;
        }

        .tab-close {
            margin-left: 8px;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            font-size: 10px;
        }

        .tab-close:hover {
            background-color: #ff4444;
            color: white;
        }

        .new-tab-btn {
            padding: 8px 12px;
            background-color: #151924;
            border: none;
            color: #40FF23;
            cursor: pointer;
            font-family: pixel;
            font-size: 12px;
            border-left: 1px solid #40FF23;
        }

        .new-tab-btn:hover {
            background-color: #1a1f2e;
        }

        .address-bar {
            background-color: #0c0e14;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #40FF23;
        }

        .nav-btn {
            width: 30px;
            height: 24px;
            background-color: #151924;
            border: 1px solid #40FF23;
            color: #40FF23;
            cursor: pointer;
            font-family: pixel;
            font-size: 12px;
        }

        .nav-btn:hover {
            background-color: #40FF23;
            color: #151924;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .url-input {
            flex: 1;
            background-color: #151924;
            border: 1px solid #40FF23;
            color: #40FF23;
            padding: 4px 8px;
            font-family: pixel;
            font-size: 12px;
            outline: none;
        }

        .url-input:focus {
            border-color: #66ff44;
            box-shadow: 0 0 5px rgba(64, 255, 35, 0.3);
        }

        .go-btn {
            background-color: #151924;
            border: 1px solid #40FF23;
            color: #40FF23;
            padding: 4px 12px;
            cursor: pointer;
            font-family: pixel;
            font-size: 12px;
        }

        .go-btn:hover {
            background-color: #40FF23;
            color: #151924;
        }

        .content-area {
            flex: 1;
            background-color: #151924;
            position: relative;
        }

        .browser-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #40FF23;
            font-size: 14px;
        }

        .status-bar {
            background-color: #0c0e14;
            border-top: 1px solid #40FF23;
            padding: 4px 8px;
            font-size: 10px;
            color: #40FF23;
            display: flex;
            justify-content: space-between;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #151924;
        }

        ::-webkit-scrollbar-thumb {
            background: #40FF23;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #66ff44;
        }
    </style>
</head>
<body>
    <div class="browser-container">
        <div class="address-bar">
            <button class="nav-btn" disabled>◀</button>
            <button class="nav-btn" disabled>▶</button>
            <button class="nav-btn">⟳</button>
            <input type="text" class="url-input" placeholder="Introduce una URL..." value="https://tampiguessr-17a8b.web.app/">
            <button class="go-btn">IR</button>
        </div>

        <div class="tabs-container">
            <div class="tab active" data-tab-id="1">
                <span>TampiGuessr</span>
                <div class="tab-close">×</div>
            </div>
            <button class="new-tab-btn" id="new-tab-btn">+</button>
        </div>
        
        <div class="content-area">
            <iframe class="browser-iframe" src="" allow="geolocation *"></iframe>
            <div class="loading" style="display: none;">Cargando...</div>
        </div>

        <div class="status-bar">
            <span class="status-text">Listo</span>
            <span class="page-info">https://tampiguessr-17a8b.web.app/</span>
        </div>
    </div>

    <script>
        class BrowserState {
            constructor() {
                this.tabs = new Map();
                this.currentTabId = null;
                this.tabCounter = 0;
                this.defaultHomepage = 'https://tampiguessr-17a8b.web.app/';
            }

            createTab(url = null, title = null) {
                this.tabCounter++;
                const tabId = this.tabCounter;
                
                const tab = {
                    id: tabId,
                    title: title || 'Nueva pestaña',
                    url: url || this.defaultHomepage,
                    history: [],
                    historyIndex: -1,
                    isLocal: this.isLocalUrl(url || this.defaultHomepage)
                };

                this.tabs.set(tabId, tab);
                return tab;
            }

            getTab(tabId) {
                return this.tabs.get(tabId);
            }

            deleteTab(tabId) {
                this.tabs.delete(tabId);
            }

            getCurrentTab() {
                return this.tabs.get(this.currentTabId);
            }

            setCurrentTab(tabId) {
                this.currentTabId = tabId;
            }

            getAllTabs() {
                return Array.from(this.tabs.values());
            }

            getTabCount() {
                return this.tabs.size;
            }

            isLocalUrl(url) {
                return url.startsWith('about:') || url.startsWith('chrome://');
            }

            addToHistory(tabId, url) {
                const tab = this.getTab(tabId);
                if (!tab) return;

                if (tab.historyIndex < tab.history.length - 1) {
                    tab.history = tab.history.slice(0, tab.historyIndex + 1);
                }

                tab.history.push(url);
                tab.historyIndex = tab.history.length - 1;
            }

            canGoBack(tabId) {
                const tab = this.getTab(tabId);
                return tab && tab.historyIndex > 0;
            }

            canGoForward(tabId) {
                const tab = this.getTab(tabId);
                return tab && tab.historyIndex < tab.history.length - 1;
            }

            goBack(tabId) {
                const tab = this.getTab(tabId);
                if (this.canGoBack(tabId)) {
                    tab.historyIndex--;
                    return tab.history[tab.historyIndex];
                }
                return null;
            }

            goForward(tabId) {
                const tab = this.getTab(tabId);
                if (this.canGoForward(tabId)) {
                    tab.historyIndex++;
                    return tab.history[tab.historyIndex];
                }
                return null;
            }
        }

        class BrowserUI {
            constructor(state) {
                this.state = state;
                this.elements = {
                    tabsContainer: document.querySelector('.tabs-container'),
                    newTabBtn: document.getElementById('new-tab-btn'),
                    urlInput: document.querySelector('.url-input'),
                    iframe: document.querySelector('.browser-iframe'),
                    statusText: document.querySelector('.status-text'),
                    pageInfo: document.querySelector('.page-info'),
                    backBtn: document.querySelector('.nav-btn:nth-child(1)'),
                    forwardBtn: document.querySelector('.nav-btn:nth-child(2)'),
                    refreshBtn: document.querySelector('.nav-btn:nth-child(3)'),
                    goBtn: document.querySelector('.go-btn')
                };
            }

            createTabElement(tab) {
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.setAttribute('data-tab-id', tab.id);
                
                const displayTitle = this.getTitleForDisplay(tab.title);
                
                tabElement.innerHTML = `
                    <span>${displayTitle}</span>
                    <div class="tab-close">×</div>
                `;

                tabElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        browser.switchToTab(tab.id);
                    }
                });

                const closeBtn = tabElement.querySelector('.tab-close');
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    browser.closeTab(tab.id);
                });

                return tabElement;
            }

            addTabToUI(tab) {
                const tabElement = this.createTabElement(tab);
                this.elements.tabsContainer.insertBefore(tabElement, this.elements.newTabBtn);
                return tabElement;
            }

            removeTabFromUI(tabId) {
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) {
                    tabElement.remove();
                }
            }

            setActiveTab(tabId) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }

            updateTabTitle(tabId, title) {
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"] span`);
                if (tabElement) {
                    tabElement.textContent = this.getTitleForDisplay(title);
                }
            }

            getTitleForDisplay(title) {
                return title.length > 20 ? title.substring(0, 17) + '...' : title;
            }

            loadContent(tab) {
                if (!tab) return;

                this.elements.urlInput.value = tab.url;
                this.elements.pageInfo.textContent = tab.url;
                this.updateNavigationButtons();

                this.elements.iframe.onload = null;
                this.elements.iframe.onerror = null;

                if (this.state.isLocalUrl(tab.url)) {
                    this.loadLocalContent(tab);
                } else {
                    this.loadExternalContent(tab);
                }
            }

            loadLocalContent(tab) {
                this.elements.iframe.src = '';
                this.elements.iframe.srcdoc = this.getLocalContent(tab.url);
                this.elements.statusText.textContent = 'Listo';
            }

            loadExternalContent(tab) {
                this.elements.statusText.textContent = 'Cargando...';
                this.elements.iframe.removeAttribute('srcdoc');
                this.elements.iframe.src = tab.url;

                this.elements.iframe.onload = () => {
                    this.elements.statusText.textContent = 'Listo';
                };

                this.elements.iframe.onerror = () => {
                    this.elements.statusText.textContent = 'Error al cargar';
                };
            }

            getLocalContent(url) {
                if (url === 'about:blank' || url === 'chrome://newtab') {
                    return `
                        <div style="font-family: pixel; background: #151924; color: #40FF23; padding: 20px; text-align: center; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <h1>Nueva pestaña</h1>
                            <p>Introduce una URL para navegar</p>
                        </div>
                    `;
                }

                return `
                    <div style="font-family: pixel; background: #151924; color: #40FF23; padding: 20px; text-align: center; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <h1>Página no encontrada</h1>
                        <p>La página local solicitada no existe.</p>
                    </div>
                `;
            }

            updateNavigationButtons() {
                const currentTab = this.state.getCurrentTab();
                if (!currentTab) return;

                this.elements.backBtn.disabled = !this.state.canGoBack(currentTab.id);
                this.elements.forwardBtn.disabled = !this.state.canGoForward(currentTab.id);
            }

            normalizeUrl(url) {
                url = url.trim();
                
                if (!url) return this.state.defaultHomepage;
                
                if (url.startsWith('http://') || url.startsWith('https://') || 
                    url.startsWith('about:') || url.startsWith('chrome://')) {
                    return url;
                }
                
                if (url.includes('.')) {
                    return 'https://' + url;
                }
                
                return 'https://www.google.com/search?q=' + encodeURIComponent(url);
            }

            extractTitleFromUrl(url) {
                try {
                    const urlObj = new URL(url);
                    return urlObj.hostname.replace('www.', '');
                } catch(e) {
                    return url;
                }
            }
        }

        class Browser {
            constructor() {
                this.state = new BrowserState();
                this.ui = new BrowserUI(this.state);
                this.initialize();
            }

            initialize() {
                const initialTab = this.state.createTab(
                    this.state.defaultHomepage,
                    'TampiGuessr'
                );
                
                this.state.setCurrentTab(initialTab.id);
                this.state.addToHistory(initialTab.id, initialTab.url);
                
                this.ui.setActiveTab(initialTab.id);
                this.ui.loadContent(initialTab);
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.ui.elements.newTabBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.createNewTab();
                });

                this.ui.elements.goBtn.addEventListener('click', () => {
                    this.navigate();
                });

                this.ui.elements.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.navigate();
                    }
                });

                this.ui.elements.backBtn.addEventListener('click', () => {
                    this.goBack();
                });

                this.ui.elements.forwardBtn.addEventListener('click', () => {
                    this.goForward();
                });

                this.ui.elements.refreshBtn.addEventListener('click', () => {
                    this.refresh();
                });

                const initialTabElement = document.querySelector('[data-tab-id="1"]');
                if (initialTabElement) {
                    const closeBtn = initialTabElement.querySelector('.tab-close');
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.closeTab(1);
                    });
                }
            }

            createNewTab(url = null) {
                const newTab = this.state.createTab(url);
                this.ui.addTabToUI(newTab);
                this.switchToTab(newTab.id);
                
                if (url) {
                    this.state.addToHistory(newTab.id, url);
                }
            }

            switchToTab(tabId) {
                const tab = this.state.getTab(tabId);
                if (!tab) return;

                this.state.setCurrentTab(tabId);
                this.ui.setActiveTab(tabId);
                this.ui.loadContent(tab);
            }

            closeTab(tabId) {
                if (this.state.getTabCount() === 1) return;

                if (this.state.currentTabId === tabId) {
                    const allTabs = this.state.getAllTabs();
                    const nextTab = allTabs.find(t => t.id !== tabId);
                    if (nextTab) {
                        this.switchToTab(nextTab.id);
                    }
                }

                this.state.deleteTab(tabId);
                this.ui.removeTabFromUI(tabId);
            }

            navigate(url = null) {
                const currentTab = this.state.getCurrentTab();
                if (!currentTab) return;

                if (!url) {
                    url = this.ui.elements.urlInput.value;
                }

                url = this.ui.normalizeUrl(url);

                currentTab.url = url;
                currentTab.isLocal = this.state.isLocalUrl(url);
                
                const title = this.ui.extractTitleFromUrl(url);
                currentTab.title = title;
                this.ui.updateTabTitle(currentTab.id, title);

                this.state.addToHistory(currentTab.id, url);

                this.ui.loadContent(currentTab);
            }

            goBack() {
                const currentTab = this.state.getCurrentTab();
                if (!currentTab) return;

                const url = this.state.goBack(currentTab.id);
                if (url) {
                    currentTab.url = url;
                    currentTab.title = this.ui.extractTitleFromUrl(url);
                    this.ui.updateTabTitle(currentTab.id, currentTab.title);
                    this.ui.loadContent(currentTab);
                }
            }

            goForward() {
                const currentTab = this.state.getCurrentTab();
                if (!currentTab) return;

                const url = this.state.goForward(currentTab.id);
                if (url) {
                    currentTab.url = url;
                    currentTab.title = this.ui.extractTitleFromUrl(url);
                    this.ui.updateTabTitle(currentTab.id, currentTab.title);
                    this.ui.loadContent(currentTab);
                }
            }

            refresh() {
                const currentTab = this.state.getCurrentTab();
                if (currentTab) {
                    this.ui.loadContent(currentTab);
                }
            }
        }

        let browser;

        document.addEventListener('DOMContentLoaded', function() {
            browser = new Browser();
        });
    </script>
</body>
</html>
